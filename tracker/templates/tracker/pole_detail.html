{% extends 'tracker/base.html' %}
{% load tracker_extras %}

{% block content %}
<div class="container py-4">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h5 class="text-muted mb-1">{{ pole.project.name }}</h5>
            <div class="d-flex align-items-center gap-2">
                <h2 class="fw-bold mb-0">{{ pole.identifier }}</h2>
                <span class="badge bg-secondary fs-6">{{ pole.custom_id }}</span>
            </div>
        </div>
        <a href="{% url 'project_detail' pole.project.id %}" class="btn btn-outline-secondary rounded-pill px-4">
            &larr; Back
        </a>
    </div>

    {% if pole.has_open_issue %}
    <div class="alert alert-danger shadow-sm border-danger border-2 mb-4 rounded-3">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h4 class="alert-heading fw-bold">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i> Correction Required
                </h4>
                <p class="mb-2">The client has flagged an issue. Please fix and re-upload evidence.</p>
            </div>
            
            {% if user.is_superuser or user.is_staff %}
                {% for issue in pole.issues.all %}
                    {% if issue.status == 'OPEN' %}
                        <a href="{% url 'resolve_issue' issue.id %}" class="btn btn-light text-danger fw-bold shadow-sm">
                            ✅ Mark Resolved
                        </a>
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>

        <hr>
        
        <div class="bg-white p-3 rounded text-danger border border-danger border-opacity-25">
            <h6 class="fw-bold mb-2">Client Feedback:</h6>
            {% for issue in pole.issues.all %}
                {% if issue.status == 'OPEN' %}
                    <p class="mb-0 fst-italic">"{{ issue.message }}"</p>
                    <small class="text-muted d-block mt-1 text-end">- Reported by {{ issue.reported_by }} on {{ issue.created_at|date:"M d, Y" }}</small>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
    

    <div class="card shadow-sm mb-4 border-0 rounded-4">
        <div class="card-body p-4">
            {% if pole.is_completed %}
                <div class="alert alert-success fw-bold d-flex align-items-center rounded-3 mb-0">
                    <i class="bi bi-check-circle-fill fs-4 me-2"></i> All Stages Completed!
                </div>
            {% else %}
                <div class="d-flex justify-content-between mb-1">
                    <small class="fw-bold text-dark">Completion Progress</small>
                    <small class="text-muted">{{ pole.progress_percent }}%</small>
                </div>
                <div class="progress" style="height: 15px; border-radius: 10px;">
                    <div class="progress-bar bg-primary" role="progressbar" style="width: {{ pole.progress_percent }}%"></div>
                </div>
            {% endif %}
        </div>
    </div>

    <h4 class="mb-3 fw-bold text-dark">Construction Stages</h4>

    <div class="row g-4">
        {% for stage in stages %}
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 shadow-sm border-0 rounded-4 overflow-hidden position-relative">
                    
                    <div class="card-header bg-white d-flex justify-content-between align-items-center py-3 border-0">
                        <span class="fw-bold fs-5">{{ stage.name }}</span>
                        {% if stage.id in evidence_map %}
                            <span class="badge bg-success rounded-pill">Done</span>
                        {% elif stage.is_locked %}
                            <span class="badge bg-secondary rounded-pill"><i class="bi bi-lock-fill"></i> Locked</span>
                        {% else %}
                            <span class="badge bg-warning text-dark rounded-pill">Current Step</span>
                        {% endif %}
                    </div>

                    <div class="card-body text-center d-flex flex-column justify-content-center p-4 bg-light">
                        
                        {% if stage.id in evidence_map %}
                            {% with evidence=evidence_map|get_item:stage.id %}
                                <div class="position-relative mb-3 group-hover">
                                    <img src="{{ evidence.image.url }}" 
                                         class="img-fluid rounded-3 shadow-sm cursor-pointer hover-scale" 
                                         style="height: 200px; width: 100%; object-fit: cover;"
                                         onclick="openImageModal('{{ evidence.image.url }}', '{{ stage.name }}')">
                                    
                                    <div class="mt-2 text-muted small">
                                        <i class="bi bi-clock"></i> {{ evidence.captured_at|date:"M d, H:i" }}
                                    </div>
                                </div>

                                <a href="{% url 'delete_evidence' evidence.id %}" 
                                   class="btn btn-outline-danger w-100 rounded-pill"
                                   onclick="return confirm('Delete this photo? You will need to upload a new one.');">
                                   <i class="bi bi-trash"></i> Delete & Replace
                                </a>
                            {% endwith %}

                        {% elif stage.is_locked %}
                            <div class="mb-3 text-muted opacity-25">
                                <i class="bi bi-lock-fill display-1"></i>
                            </div>
                            <button disabled class="btn btn-secondary w-100 rounded-pill py-2 opacity-50">
                                Complete Previous Step
                            </button>

                        {% else %}
                            <div class="mb-3 text-muted opacity-50">
                                <i class="bi bi-camera-fill display-4"></i>
                            </div>
                            <button type="button" class="btn btn-primary w-100 rounded-pill py-2 fw-bold shadow-sm" 
                                    onclick="openCamera('{{ stage.id }}', '{{ stage.name }}')">
                                <i class="bi bi-upload me-2"></i> Upload Photo
                            </button>
                        {% endif %}

                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4">
            <div class="modal-header bg-primary text-white rounded-top-4">
                <h5 class="modal-title">Upload: <span id="modalStageName"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <form method="post" enctype="multipart/form-data" id="uploadForm">
                {% csrf_token %}
                <div class="modal-body p-4">
                    <input type="hidden" name="stage_id" id="inputStageId">
                    <input type="hidden" name="gps_lat" id="lat">
                    <input type="hidden" name="gps_long" id="lon">

                    <div class="mb-4 text-center">
                        <input type="file" name="image" class="form-control form-control-lg" accept="image/*" capture="environment" required>
                    </div>

                    <div id="locationStatus" class="d-flex align-items-center justify-content-center gap-2 p-2 rounded bg-light text-muted small">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <span>Acquiring Location...</span>
                    </div>
                </div>
                <div class="modal-footer border-0 p-3">
                    <button type="submit" class="btn btn-success w-100 btn-lg rounded-pill" id="submitBtn">
                        Confirm Upload
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-transparent border-0">
            <div class="modal-body text-center position-relative p-0">
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3 z-3" data-bs-dismiss="modal"></button>
                <img id="enlargedImage" src="" class="img-fluid rounded shadow-lg" style="max-height: 90vh;">
                <div class="mt-2">
                    <span id="imageCaption" class="badge bg-dark fs-6 px-3 py-2"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // IMAGE ZOOM
    function openImageModal(url, caption) {
        document.getElementById('enlargedImage').src = url;
        document.getElementById('imageCaption').innerText = caption;
        new bootstrap.Modal(document.getElementById('imageModal')).show();
    }

    // CAMERA & GPS
    function openCamera(stageId, stageName) {
        document.getElementById('inputStageId').value = stageId;
        document.getElementById('modalStageName').innerText = stageName;
        
        // Reset Logic (Ensure button is clickable again when reopening)
        var btn = document.getElementById("submitBtn");
        btn.disabled = false; 
        btn.innerHTML = "Confirm Upload"; 

        var status = document.getElementById("locationStatus");
        status.className = "d-flex align-items-center justify-content-center gap-2 p-2 rounded bg-light text-muted small";
        status.innerHTML = '<div class="spinner-border spinner-border-sm"></div> <span>Acquiring Location...</span>';

        new bootstrap.Modal(document.getElementById('uploadModal')).show();

        // Get GPS
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    document.getElementById("lat").value = position.coords.latitude.toFixed(6);
                    document.getElementById("lon").value = position.coords.longitude.toFixed(6);
                    
                    var status = document.getElementById("locationStatus");
                    status.className = "alert alert-success py-2 small mb-0 text-center fw-bold w-100";
                    status.innerHTML = '<i class="bi bi-geo-alt-fill"></i> Location Locked';
                }, 
                function(error) {
                    console.log("GPS Error");
                    var status = document.getElementById("locationStatus");
                    status.className = "alert alert-warning py-2 small mb-0 text-center w-100";
                    status.innerHTML = "⚠️ GPS Weak - Using Photo Metadata";
                }, 
                {timeout: 10000, enableHighAccuracy: true}
            );
        }
    }

    // PREVENT DOUBLE SUBMISSIONS
    const form = document.getElementById('uploadForm');
    form.addEventListener('submit', function() {
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';
    });
</script>

<style>
    .hover-scale:hover { transform: scale(1.02); transition: transform 0.2s ease-in-out; cursor: zoom-in; }
</style>

{% endblock %}