{% extends 'tracker/base.html' %}
{% load tracker_extras %}

{% block content %}
<div class="container py-4">
    
    <div class="card shadow-sm mb-4 border-0 rounded-4">
        <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="text-muted mb-1">{{ pole.project.name }}</h5>
                    <h2 class="fw-bold text-dark mb-0">{{ pole.identifier }}</h2>
                </div>
                <a href="{% url 'project_detail' pole.project.id %}" class="btn btn-outline-secondary rounded-pill">
                    &larr; Back
                </a>
            </div>
            
            <hr class="my-3 opacity-25">

            {% if pole.is_completed %}
                <div class="alert alert-success fw-bold d-flex align-items-center rounded-3">
                    <i class="bi bi-check-circle-fill fs-4 me-2"></i> All Stages Completed!
                </div>
            {% else %}
                <div class="d-flex justify-content-between mb-1">
                    <small class="fw-bold text-dark">Progress</small>
                    <small class="text-muted">{{ pole.progress_percent }}%</small>
                </div>
                <div class="progress" style="height: 15px; border-radius: 10px;">
                    <div class="progress-bar bg-primary" role="progressbar" 
                         style="width: {{ pole.progress_percent }}%">
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <h4 class="mb-3 fw-bold text-dark">Construction Stages</h4>

    <div class="row g-4">
        {% for stage in stages %}
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 shadow-sm border-0 rounded-4 overflow-hidden position-relative">
                    
                    <div class="card-header bg-white d-flex justify-content-between align-items-center py-3 border-0">
                        <span class="fw-bold fs-5">{{ stage.name }}</span>
                        {% if stage.id in evidence_map %}
                            <span class="badge bg-success rounded-pill">Done</span>
                        {% else %}
                            <span class="badge bg-secondary rounded-pill text-light opacity-50">Pending</span>
                        {% endif %}
                    </div>

                    <div class="card-body text-center d-flex flex-column justify-content-center p-4 bg-light">
                        
                        {% if stage.id in evidence_map %}
                            {% with evidence=evidence_map|get_item:stage.id %}
                                <div class="position-relative mb-3 group-hover">
                                    <img src="{{ evidence.image.url }}" 
                                         class="img-fluid rounded-3 shadow-sm cursor-pointer hover-scale" 
                                         style="height: 200px; width: 100%; object-fit: cover;"
                                         onclick="openImageModal('{{ evidence.image.url }}', '{{ stage.name }}')">
                                    
                                    <div class="mt-2 text-muted small">
                                        <i class="bi bi-clock"></i> {{ evidence.captured_at|date:"M d, H:i" }}
                                    </div>
                                </div>

                                <a href="{% url 'delete_evidence' evidence.id %}" 
                                   class="btn btn-outline-danger w-100 rounded-pill"
                                   onclick="return confirm('Delete this photo? You will need to upload a new one.');">
                                   <i class="bi bi-trash"></i> Delete & Replace
                                </a>
                            {% endwith %}

                        {% else %}
                            <div class="mb-3 text-muted opacity-50">
                                <i class="bi bi-camera-fill display-4"></i>
                            </div>
                            <button type="button" class="btn btn-primary w-100 rounded-pill py-2 fw-bold shadow-sm" 
                                    onclick="openCamera('{{ stage.id }}', '{{ stage.name }}')">
                                <i class="bi bi-upload me-2"></i> Upload Photo
                            </button>
                        {% endif %}

                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4">
            <div class="modal-header bg-primary text-white rounded-top-4">
                <h5 class="modal-title">Upload for: <span id="modalStageName" class="fw-bold"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <form method="post" enctype="multipart/form-data" id="uploadForm">
                {% csrf_token %}
                <div class="modal-body p-4">
                    
                    <input type="hidden" name="stage_id" id="inputStageId">
                    <input type="hidden" name="gps_lat" id="lat">
                    <input type="hidden" name="gps_long" id="lon">

                    <div class="mb-4 text-center">
                        <label class="form-label fw-bold mb-3">Take a Photo</label>
                        <input type="file" name="image" class="form-control form-control-lg" accept="image/*" capture="environment" required>
                    </div>

                    <div id="locationStatus" class="d-flex align-items-center justify-content-center gap-2 p-2 rounded bg-light text-muted small">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <span>Acquiring Location...</span>
                    </div>

                </div>
                <div class="modal-footer border-0 p-3">
                    <button type="submit" class="btn btn-success w-100 btn-lg rounded-pill" id="submitBtn">
                        Confirm Upload
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-transparent border-0">
            <div class="modal-body text-center position-relative p-0">
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3 z-3" data-bs-dismiss="modal"></button>
                <img id="enlargedImage" src="" class="img-fluid rounded shadow-lg" style="max-height: 90vh;">
                <div class="mt-2">
                    <span id="imageCaption" class="badge bg-dark fs-6 px-3 py-2"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. IMAGE ENLARGE LOGIC ---
    function openImageModal(url, caption) {
        document.getElementById('enlargedImage').src = url;
        document.getElementById('imageCaption').innerText = caption;
        new bootstrap.Modal(document.getElementById('imageModal')).show();
    }

    // --- 2. UPLOAD & GPS LOGIC ---
    function openCamera(stageId, stageName) {
        document.getElementById('inputStageId').value = stageId;
        document.getElementById('modalStageName').innerText = stageName;
        
        // Reset status
        document.getElementById("submitBtn").disabled = false; 
        var status = document.getElementById("locationStatus");
        status.className = "d-flex align-items-center justify-content-center gap-2 p-2 rounded bg-light text-muted small";
        status.innerHTML = '<div class="spinner-border spinner-border-sm"></div> <span>Acquiring Location...</span>';

        var myModal = new bootstrap.Modal(document.getElementById('uploadModal'));
        myModal.show();

        // Start GPS fetch
        getLocation();
    }

    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition, showError, {timeout: 10000, enableHighAccuracy: true});
        } else {
            showError();
        }
    }

    function showPosition(position) {
        document.getElementById("lat").value = position.coords.latitude.toFixed(6);
        document.getElementById("lon").value = position.coords.longitude.toFixed(6);
        
        var status = document.getElementById("locationStatus");
        status.className = "alert alert-success py-2 small mb-0 text-center fw-bold";
        status.innerHTML = '<i class="bi bi-geo-alt-fill"></i> Location Locked';
    }

    function showError(error) {
        console.log("GPS Timeout/Error");
        var status = document.getElementById("locationStatus");
        status.className = "alert alert-warning py-2 small mb-0 text-center";
        status.innerHTML = "⚠️ GPS Weak - Using Photo Data";
    }
</script>

<style>
    .hover-scale:hover {
        transform: scale(1.02);
        transition: transform 0.2s ease-in-out;
        cursor: zoom-in;
    }
    .cursor-pointer {
        cursor: pointer;
    }
</style>

{% endblock %}